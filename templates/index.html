{% extends "layout.html" %}
{% block body %}
      <div id="contents">

        <div id="helpcontent">
          <h3><a href="#">Basic Usage</a></h3>
          <div>
            <p>
            Basic usage explained here.
            Mauris mauris ante, blandit et, ultrices a, suscipit eget, quam. Integer
            ut neque. Vivamus nisi metus, molestie vel, gravida in, condimentum sit
            amet, nunc. Nam a nibh. Donec suscipit eros. Nam mi. Proin viverra leo ut
            odio. Curabitur malesuada. Vestibulum a velit eu ante scelerisque vulputate.
            </p>
          </div>
          <h3><a href="#">Nucleotide Ambiguity Codes</a></h3>
          <div>
            <p>
            A table with ambiguity codes.
            Mauris mauris ante, blandit et, ultrices a, suscipit eget, quam. Integer
            ut neque. Vivamus nisi metus, molestie vel, gravida in, condimentum sit
            amet, nunc. Nam a nibh. Donec suscipit eros. Nam mi. Proin viverra leo ut
            odio. Curabitur malesuada. Vestibulum a velit eu ante scelerisque vulputate.
            </p>
          </div>
          <h3><a href="#">Common Patterns</a></h3>
          <div>
            <p>
            A couple of common patterns should be selectable from here.
            Mauris mauris ante, blandit et, ultrices a, suscipit eget, quam. Integer
            ut neque. Vivamus nisi metus, molestie vel, gravida in, condimentum sit
            amet, nunc. Nam a nibh. Donec suscipit eros. Nam mi. Proin viverra leo ut
            odio. Curabitur malesuada. Vestibulum a velit eu ante scelerisque vulputate.
            </p>
          </div>
        </div>

        <div id="upload">
          <form>
            <input id="new-file" type="file" name="file">
          </form>
        </div>

        <div id="settings">
          <ul id="menu">
            <li id="molecule-type">
              <input type="radio" name="molecule" id="DNA" value="DNA" data-bind="checked: molecule" /><label for="DNA">DNA</label>
              <input type="radio" name="molecule" id="protein" value="protein" data-bind="checked: molecule" /><label for="protein">Protein</label>
            </li>
            <li>
              <input type="checkbox" id="preview" data-bind="checked: preview" />
              <label for="preview">Continuous Preview</label></p>
            </li>
            <li>
              <button id="clear-button" data-bind="click: clearPatterns">Clear all Patterns</button>
            </li>
            <li>
              <button id="demo-button" data-bind="click: demo">Show Example</button>
            </li>
          </ul>
        </div>

        <div id="drop-area">
          <div data-bind="visible: pattern_list().length == 0">Drop new patterns here</div>
          <div id="pattern-list" data-bind="sortable: {template: getTemplate, data: pattern_list, options: {distance: 5, paceholder: 'placeholder'},
                                            afterMove: refreshButtons}">
          </div>
        </div>

        <div id="pattern">
          <h3><a href="#">Computed Pattern</a></h3>
          <div>
            <textarea data-bind="value: pattern, attr: {cols: 80, rows: 2}"></textarea>
          </div>
        </div>

        <div id="result">
          <p>Results:
          <textarea data-bind="value: result, attr: {cols: 80, rows: 4}"></textarea>
        </div>

      </div>

      <div id="pattern-selections">

        <ul class="prototype-container" data-bind="foreach: constructors">
          <li class="prototype" data-bind="drag: constructor, text: text,
                                           visible: show_for == 'all' || show_for == $root.molecule(),
                                           dragOptions: { stop: $root.refreshButtons }"></li>
        </ul>



        <div id="trash-container">
          <p>Trash</p>
          <div id="trash" data-bind="sortable: trash">
          </div>
        </div>

      </div>

    </div>
{% endblock %}
{% block scripts %}
    <script id="string-template" type="text/html">
      <div class="pattern">
        <label data-bind="visible: $parent.allow_named, uniqueFor: named">Named</label>
        <input type="checkbox" data-bind="visible: $parent.allow_named, checked: named, uniqueId: named" class="toggle"/>
        <input type="text" data-bind="value: sequence">
        <span data-bind="template: { name: 'variations-template', data: variations }"></span>
        <button class="reverse-complement" data-bind="click: reverseComplement, visible: $root.molecule() == 'DNA'">Reverse Complement</button>
      </div>
    </script>

    <script id="range-template" type="text/html">
      <div class="pattern">
        <label data-bind="visible: $parent.allow_named, uniqueFor: named">Named</label>
        <input type="checkbox" data-bind="visible: $parent.allow_named, checked: named, uniqueId: named" class="toggle"/>
        <label>From: <input type="text" size="5" data-bind="value: from" /></label>
        <label>To: <input type="text" size="5" data-bind="value: to" /></label>
      </div>
    </script>

    <script id="complement-template" type="text/html">
      <div class="pattern">
        <label data-bind="visible: $parent.allow_named, uniqueFor: named">Named</label>
        <input type="checkbox" data-bind="visible: $parent.allow_named, checked: named, uniqueId: named" class="toggle"/>
        <label>Complement of:
          <select data-bind="options: $root.namedPatterns,
                             optionsText: $root.getNamedPatternName,
                             value: selected,
                             optionsCaption: 'Choose...'">
          </select>
        </label>
        <span data-bind="template: { name: 'variations-template', data: variations }"></span>
        <label data-bind="visible: $root.complementRules().length > 0">Ruleset:
          <select data-bind="options: $root.complementRules,
                             optionsText: $root.getNamedPatternName,
                             value: ruleset,
                             optionsCaption: 'default'">
          </select>
        </label>
      </div>
    </script>

    <script id="repeat-template" type="text/html">
      <div class="pattern">
        <label data-bind="visible: $parent.allow_named, uniqueFor: named">Named</label>
        <input type="checkbox" data-bind="visible: $parent.allow_named, checked: named, uniqueId: named" class="toggle"/>
        <label>Repeat of:
          <select data-bind="options: $root.namedPatterns,
                             optionsText: $root.getNamedPatternName,
                             value: selected,
                             optionsCaption: 'Choose...'">
          </select>
        </label>
        <span data-bind="template: { name: 'variations-template', data: variations }"></span>
      </div>
    </script>

    <script id="alternative-template" type="text/html">
      <div class="pattern">
        <div class="sub-drop" data-bind="sortable: {template: $root.getTemplate, data: sub_patterns,
                                                    options: {distance: 5, forcePlaceholderSize: true},
                                                    afterMove: $root.refreshButtons, allowDrop: canDrop}">
        </div>
      </div>
    </script>

    <script id="anyof-template" type="text/html">
      <div class="pattern">
        <label data-bind="visible: $parent.allow_named, uniqueFor: named">Named</label>
        <input type="checkbox" data-bind="visible: $parent.allow_named, checked: named, uniqueId: named" class="toggle"/>
        <label>Any of: <input type="text" data-bind="value: sequence"></label>
      </div>
    </script>

    <script id="notanyof-template" type="text/html">
      <div class="pattern">
        <label data-bind="visible: $parent.allow_named, uniqueFor: named">Named</label>
        <input type="checkbox" data-bind="visible: $parent.allow_named, checked: named, uniqueId: named" class="toggle"/>
        <label>Not any of: <input type="text" data-bind="value: sequence"></label>
      </div>
    </script>

    <script id="length-template" type="text/html">
      <div class="pattern">
        <label data-bind="visible: $parent.allow_named, uniqueFor: named">Named</label>
        <input type="checkbox" data-bind="visible: $parent.allow_named, checked: named, uniqueId: named" class="toggle"/>
        <label>Length of:
          <select data-bind="options: $root.namedPatterns,
                             optionsText: $root.getNamedPatternName,
                             selectedOptions: selected"
                             multiple="true">
          </select>
        </label>
        <label>is less than:<input type="text" data-bind="value: length" size="3"></label>
      </div>
    </script>

    <script id="weight-template" type="text/html">
      <div class="pattern">
        <label data-bind="visible: $parent.allow_named, uniqueFor: named">Named</label>
        <input type="checkbox" data-bind="visible: $parent.allow_named, checked: named, uniqueId: named" class="toggle"/>
        <button class="toggle" data-bind="click: addWeight">Add Weight</button>
        <ul class="weight-matrix">
          <li class="weight-label">
            <ul>
              <li><strong>A</strong></li>
              <li><strong>C</strong></li>
              <li><strong>G</strong></li>
              <li><strong>T</strong></li>
              <li>&nbsp;</li>
            </ul>
          </li>
          <!-- ko foreach: matrix -->
          <li class="weight" data-bind="css: { 'ui-state-error': isInvalid() }">
            <ul>
              <li><input type="text" size="3" data-bind="value: a"></li>
              <li><input type="text" size="3" data-bind="value: c"></li>
              <li><input type="text" size="3" data-bind="value: g"></li>
              <li><input type="text" size="3" data-bind="value: t"></li>
              <li><button class="remove" data-bind="click: $parent.removeWeight">remove</button></li>
            </ul>
          </li>
          <!-- /ko -->
        </ul>
        <br>
        <label>Weight: <input type="text" size=4 data-bind="value: weight"></label>
      </div>
    </script>

    <script id="complement-rule-template" type="text/html">
      <div class="pattern">
        <button class="toggle" data-bind="click: addComplementPair">Add Complement Pair</button>
        <ul class="complement-ruleset">
          <li>Complement pairs: </li>
          <!-- ko foreach: ruleset -->
          <li>
          <ul class="complement-pair" data-bind="css: { 'ui-state-error': isInvalid() }">
              <li><input type="text" size=2 data-bind="value: sequence"></li>
              <li><button class="remove" data-bind="click: $parent.removeComplementPair">remove</button></li>
            </ul>
          </li>
          <!-- /ko -->
        </ul>
      </div>
    </script>

    <script id="variations-template" type="text/html">
      <label data-bind="uniqueFor: show">Variations</label><input type="checkbox" class="toggle" data-bind="checked: show, uniqueId: show"/>
      <label data-bind="visible: show">Mutations: <input type="text" size="3" data-bind="value: mutations" /></label>
      <label data-bind="visible: show">Insertions: <input type="text" size="3" data-bind="value: insertions" /></label>
      <label data-bind="visible: show">Deletions: <input type="text" size="3" data-bind="value: deletions" /></label>
    </script>

    <script src="{{ url_for('static', filename="js/jquery-1.7.2.min.js") }}"></script>
    <script src="{{ url_for('static', filename="js/jquery-ui-1.8.22.custom.min.js") }}"></script>
    <script src="{{ url_for('static', filename="js/jquery.ui.touch-punch.min.js") }}"></script>
    <script src="{{ url_for('static', filename="js/knockout.js") }}"></script>
    <script src="{{ url_for('static', filename="js/knockout-sortable.min.js") }}"></script>
    <script src="{{ url_for('static', filename="js/knockout-sortable-receive.js") }}"></script>
    <script src="{{ url_for('static', filename="js/knockout-drag.js") }}"></script>
    <script src="{{ url_for('static', filename="js/knockout-uniqueid.js") }}"></script>
    <script src="{{ url_for('static', filename="js/bio.js") }}"></script>
    <script src="{{ url_for('static', filename="js/patscan-viewmodel.js") }}"></script>
    <script type="text/javascript">

      var last_pattern = "";
      var current_file = "";

      function SubmitPattern() {
        var view_model = GetViewModel();
        if (! view_model.preview()) {
          return;
        }

        if (last_pattern == view_model.pattern()) {
          console.log("Pattern unchanged");
          return;
        }

        last_pattern = view_model.pattern();
        view_model.processing(true);
        console.log("Would submit pattern " + view_model.pattern());
        setTimeout(function() {
          view_model.processing(false);
          view_model._result("Fake result " + new Date());
        }, 2000);
      }

      function toggle_visibility() {
        $('#upload').toggle();
        $('#settings').toggle();
        $('#drop-area').toggle();
        $('#pattern').toggle();
        $('#result').toggle();
        $('#pattern-selections').toggle();
      }

      $(document).ready(function() {
        var view_model = new PatScanViewModel();
        ko.applyBindings(view_model);
        SetViewModel(view_model);

        $("#helpcontent").accordion({
          active: false,
          collapsible: true,
          clearStyle: true,
        });

        $("#pattern").accordion({
          collapsible: true,
        });

        $("#pattern-selections").position({
          of: $('#contents'),
          my: "left top",
          at: "right top",
          offset: "40% 0",
          });

        $("#footer").position({
          of: $(".page").filter(":last"),
          my: "center top",
          at: "center bottom",
          offset: "0 10%"
        });


        $(".button").button();
        $("#demo-button").button({
          icons: { primary: "ui-icon-lightbulb" }
        });


        $("#clear-button").button({
          icons: { primary: "ui-icon-trash" }
        });

        $("#preview").button({
          icons: { primary: "ui-icon-refresh" }
        });

        $("#molecule-type").buttonset();

        $(".toggle").button();
        $(".remove").button({
          icons: { primary: "ui-icon-trash" },
          text: false
        });

        $('.reverse-complement').button({
            icons: { primary: "ui-icon-transferthick-e-w" },
            text: false
        });

        $('#new-file').change(function() {
          current_file = 'fake.fa'
          toggle_visibility();
        });
        toggle_visibility();
        setInterval(SubmitPattern, 20000);

      });
    </script>
{% endblock %}
