//knockout-sortable | (c) 2012 Ryan Niemeyer | http://www.opensource.org/licenses/mit-license
(function(e,t,n){var r="ko_sortItem",i="ko_sortList",s="ko_parentList",o=function(t,n){e.utils.arrayForEach(t,function(t){t.nodeType===1&&(e.utils.domData.set(t,r,n),e.utils.domData.set(t,s,e.utils.domData.get(t.parentNode,i)))})},u=function(t){var n={},r=e.utils.unwrapObservable(t()),i;return r.data?(n.foreach=r.data,n.name=r.template):n.foreach=t(),e.utils.arrayForEach(["afterAdd","afterRender","beforeRemove","includeDestroyed","templateEngine","templateOptions"],function(t){n[t]=r[t]||e.bindingHandlers.sortable[t]}),n.afterRender?(i=n.afterRender,n.afterRender=function(e,t){o.call(t,e,t),i.call(t,e,t)}):n.afterRender=o,n};e.bindingHandlers.sortable={init:function(o,a,f,l,c){var h=t(o),p=e.utils.unwrapObservable(a())||{},d=u(a),v={},m,g;return e.utils.arrayForEach(o.childNodes,function(e){e&&e.nodeType===3&&e.parentNode.removeChild(e)}),t.extend(!0,v,e.bindingHandlers.sortable),p.options&&v.options&&(e.utils.extend(v.options,p.options),delete p.options),e.utils.extend(v,p),v.connectClass&&(e.isObservable(v.allowDrop)||typeof v.allowDrop=="function")?e.computed({read:function(){var t=e.utils.unwrapObservable(v.allowDrop),n=typeof t=="function"?t.call(this,d.foreach):t;e.utils.toggleDomNodeCssClass(o,v.connectClass,n)},disposeWhenNodeIsRemoved:o},this):e.utils.toggleDomNodeCssClass(o,v.connectClass,v.allowDrop),e.bindingHandlers.template.init(o,function(){return d},f,l,c),m=v.options.start,g=v.options.update,setTimeout(function(){h.sortable(e.utils.extend(v.options,{start:function(e,t){t.item.find("input:focus").change(),m&&m.apply(this,arguments)},update:function(n,o){var u,a,f,l,c,h,p=o.item[0],m=e.utils.domData.get(p,r);if(m){u=e.utils.domData.get(p,s),a=e.utils.domData.get(p.parentNode,i),f=e.utils.arrayIndexOf(o.item.parent().children(),p);if(!d.includeDestroyed){c=a();for(l=0;l<f;l++)c[l]&&c[l]._destroy&&f++}if(v.beforeMove||v.afterMove)h={item:m,sourceParent:u,sourceParentNode:p.parentNode,sourceIndex:u.indexOf(m),targetParent:a,targetIndex:f,cancelDrop:!1};if(v.beforeMove){v.beforeMove.call(this,h,n,o);if(h.cancelDrop){t(h.sourceParent===h.targetParent?this:o.sender).sortable("cancel");return}}f>=0&&(u.remove(m),a.splice(f,0,m)),e.utils.domData.set(p,r,null),o.item.remove(),v.afterMove&&v.afterMove.call(this,h,n,o)}g&&g.apply(this,arguments)},connectWith:v.connectClass?"."+v.connectClass:!1})),v.isEnabled!==n&&e.computed({read:function(){h.sortable(e.utils.unwrapObservable(v.isEnabled)?"enable":"disable")},disposeWhenNodeIsRemoved:o})},0),e.utils.domNodeDisposal.addDisposeCallback(o,function(){h.sortable("destroy")}),{controlsDescendantBindings:!0}},update:function(t,n,r,s,o){var a=u(n);e.utils.domData.set(t,i,a.foreach),e.bindingHandlers.template.update(t,function(){return a},r,s,o)},connectClass:"ko_container",allowDrop:!0,afterMove:null,beforeMove:null,options:{}}})(ko,jQuery)